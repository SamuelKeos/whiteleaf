[Threat - WL002 - Mass Mailer Traffic Profile - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1567"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL002 - Mass Mailer Traffic Profile
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk = 1
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"src","risk_object_type":"system","risk_score":45}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 2 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats summariesonly=true count AS num_mass_mailings dc(All_Traffic.dest) AS unique_destinations from datamodel=Network_Traffic where  All_Traffic.protocol=smtp by _time All_Traffic.src span=10min\
| rename All_Traffic.src AS src\
| eventstats median(num_mass_mailings) as median p25(num_mass_mailings) as p25 p75(num_mass_mailings) as p75 by src\
| eval IQR=(p75-p25)\
| eval sensitivity = 10\
| eval upperBound=(median+IQR*sensitivity)\
| eval isOutlier=if(num_mass_mailings > upperBound, 1, 0)\
| where (isOutlier=1)\
| eval event_time = strftime(_time,"%F %H:%M:%S")\
| eval severity=case(num_mass_mailings>100,"high",num_mass_mailings>10,"medium",1=1,"low")\
| eval urgency="high"\
| eval desc = "The host ".src." sent ".count." emails to ".unique_destinations." hosts."

[Threat - WL003 - DNS Tunneling - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1572"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL003 - DNS Tunneling
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk = 1
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"src","risk_object_type":"system","risk_score":60}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 3 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count from datamodel=Network_Resolution where NOT (DNS.message_type=Pointer OR DNS.message_type=PTR) by DNS.query DNS.src\
| rename DNS.* AS *\
| eval tlds=split(query,".")\
| eval tld=mvindex(tlds,-1)\
| eval tld_len=len(tld)\
| search tld_len<=24\
| eval query_length = len(query)\
| table query query_length record_type count src\
| eventstats median(query_length) as median p25(query_length) as p25 p75(query_length) as p75\
| eval IQR=(p75-p25)\
| eval sensitivity = 10\
| eval upperBound=(median+IQR*sensitivity)\
| eval isOutlier=if(query_length > upperBound, 1, 0)\
| where (isOutlier=1) AND query_length>100\
| eval event_time = strftime(_time,"%F %H:%M:%S")\
| eval severity="high"\
| eval urgency="high"\
| eval desc = "The asset ".src." produced an anomalously long ".query length." DNS request."

[Threat - WL004 - Anomalous ANY DNS Querying - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1498"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL004 - Anomalous ANY DNS Querying
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk = 1
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"dest","risk_object_type":"system","risk_score":60}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 4 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count from datamodel=Network_Resolution where nodename=DNS DNS.message_type=QUERY DNS.record_type=ANY by DNS.dest _time span=1h\
| rename DNS.* AS *\
| eventstats median(count) as median p25(count) as p25 p75(count) as p75 by dest\
| eval IQR=(p75-p25)\
| eval sensitivity = 3\
| eval upperBound=(median+IQR*sensitivity)\
| eval isOutlier=if(count > upperBound, 1, 0)\
| where (isOutlier=1)\
| eval event_time = strftime(_time,"%F %H:%M:%S")\
| eval severity="high"\
| eval urgency="high"\
| eval desc = "The anomalously large number of ANY DNS requests associated with ".dest." indicate a potential mailicious DDoS attack."

[Threat - WL005 - Windows Exchange Autodiscover SSRF Abuse - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1190","T1133"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL005 - Windows Exchange Autodiscover SSRF Abuse
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk = 1
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"user","risk_object_type":"user","risk_score":80},{"risk_object_field":"dest","risk_object_type":"system","risk_score":80}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 5 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where (Web.status=200) AND Web.http_method=POST by Web.src Web.status Web.uri_path Web.dest Web.http_method Web.uri_query Web.http_user_agent \
| `drop_dm_object_name("Web")` \
| eval is_autodiscover=if(like(lower(uri_path),"%autodiscover/autodiscover.json%"),1,0) \
| eval has_rps_cat=if(like(lower(uri_query),"%x-rps-cat=%"),1,0) \
| eval exchange_backend=if(like(lower(uri_query),"%/powershell/?%"),1,0) \
| eval mapi=if(like(uri_query,"%/mapi/%"),1,0) \
| eval suspicious_agent=if(match(lower(http_user_agent), "python\
|urllib"),1,0) \
| addtotals fieldname=Score is_autodiscover, has_rps_cat, exchange_backend, mapi, suspicious_agent \
| where Score >= 3 \
| fields Score, src, dest, status, uri_query, uri_path, http_method, http_user_agent

[Threat - WL014 - Blocked AWS Sign In Attempt Followed by Success - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1110"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL014 - Blocked AWS Sign In Attempt Followed by Success
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk = 1
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"user","risk_object_type":"user","risk_score":50}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 1
alert.suppress.fields = user
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 14 * * * *
disabled = 1
dispatch.earliest_time = -130m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=aws \
``` replace with... `cloudtrail` eventType="AwsConsoleSignIn" ```\
| stats count max(_time) AS latest_time min(_time) AS earliest_time by user action\
| eval most_recent_failure = if(action="failure",latest_time,0)\
| eval latest_success = if(action="success",earliest_time,9999999999)\
| stats max(most_recent_failure) As most_recent_failure  min(latest_success) AS latest_success by user| where latest_success < most_recent_failure\
| table user latest_success most_recent_failure

[Threat - WL019 - O365 Anomalous Download Activity - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1213"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL019 - O365 Anomalous Download Activity
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk = 1
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"user","risk_object_type":"user","risk_score":40}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 1
alert.suppress.fields = user
alert.suppress.period = 86400s
alert.track = 1
counttype = number of events
cron_schedule = 19 * * * *
disabled = 1
dispatch.earliest_time = -24h
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=o365 ```add o365 macro``` sourcetype=o365:management:activity (Workload=OneDrive OR Workload=SharePoint) action=downloaded NOT user="app@sharepoint"\
| bin span=1h _time\
| stats count sum(FileSizeBytes) as total_size values(Workload) as orig_source values(SourceFileName) as file_names dc(SourceFileExtension) as distinct_number_of_file_extensions by _time user\
| eventstats median(count) as median_1 p25(count) as p25_1 p75(count) as p75_1 median(total_size) as median_2 p25(total_size) as p25_2 p75(total_size) as p75_2 by user\
| eval IQR_1=(p75_1-p25_1)\
| eval IQR_2=(p75_2-p25_2)\
| eval sensitivity = 2\
| eval upperBound_1=(median_1+IQR_1*sensitivity)\
| eval upperBound_2=(median_2+IQR_2*sensitivity)\
| eval isOutlier_1=if(count > upperBound, 1, 0)\
| eval isOutlier_2=if(total_size > upperBound, 1, 0)\
| where (isOutlier_1=1 AND isOutlier_2=1)

[Threat - WL023 - AWS Impossible Travel - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1078"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL023 - AWS Impossible Travel
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk = 1
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"user","risk_object_type":"user","risk_score":80}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 1
alert.suppress.fields = user
alert.suppress.period = 10800s
alert.track = 1
counttype = number of events
cron_schedule = 23 * * * *
disabled = 1
dispatch.earliest_time = -4h
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=aws_cloudtrail sourcetype=aws:cloudtrail user=* ```aws index```\
| sort 0 user, _time \
| streamstats window=1 current=f values(_time) as last_time values(src) as last_src by user\
| iplocation last_src \
| rename lat as last_lat lon as last_lon \
| eval location = City . "|" . Country . "|" . Region\
| iplocation src\
| eval rlat1 = pi()*last_lat/180, rlat2=pi()*lat/180, rlat = pi()*(lat-last_lat)/180, rlon= pi()*(lon-last_lon)/180 \
| eval a = sin(rlat/2) * sin(rlat/2) + cos(rlat1) * cos(rlat2) * sin(rlon/2) * sin(rlon/2) \
| eval c = 2 * atan2(sqrt(a), sqrt(1-a)) \
| eval distance = 6371 * c, time_difference_in_min = round((_time - last_time) / 60,2), speed=round(distance/ ( time_difference_hours),2) \
| fields - rlat* a c\
| eval date=strftime(_time, "%m/%d/%Y")\
| stats values(aws_account_id) AS aws_accounts values(awsRegion) AS aws_regions values(eventName) AS event_names values(eval(mvappend(last_Country, Country))) as src_country values(eval(mvappend(last_City, City))) as src_city values(eval(mvappend(last_Region, Region))) as Region  values(lat) AS latitudes values(lon) AS longitudes values(userAgent) min(time_difference_in_min) as time_difference_in_min values(src) AS src_ip by date user distance\
| eval dc_lat=mvcount(latitudes), dc_lon=mvcount(longitudes), dc_city=mvcount(src_city), velocity_in_mph=(distance*0.621371)/(time_difference_in_min/60)\
| where dc_lat>1 AND dc_lon>1 AND dc_city>1 AND (time_difference_in_min=0.00 OR velocity_in_mph>700)\
| fields - dc_city dc_lat dc_lon\
```exclude source cities```

[Threat - WL001 - DGA Domains - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1568"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL001 - DGA Domains
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 1 * * * *
description = This search looks for traffic from sources to DGA domains. The riskiness of the domain (1-100) is returned from Whiteleaf AI and then applied to the source in the risk index.
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats values(DNS.answer) as IPs min(_time) as firstTime  max(_time) as lastTime from datamodel=Network_Resolution by DNS.src, DNS.query \
| `drop_dm_object_name(DNS)` \
| rename query AS domain \
| fields IPs, src, domain, firstTime, lastTime\
| eval whiteleafuc="WLUC1"\
| eval prompt = domain\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=src param.risk_object_type=system

[Threat - WL006 - SQL Injection - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1190"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL006 - SQL Injection
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 6 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count from datamodel=Web where Web.dest_category=web_server AND (Web.url_length > 1024 OR Web.http_user_agent_length > 200) by Web.src Web.dest Web.url Web.url_length Web.http_user_agent \
| `drop_dm_object_name("Web")` \
| eval url=lower(url) \
| eval num_sql_cmds=mvcount(split(url, "alter%20table")) + mvcount(split(url, "between")) + mvcount(split(url, "create%20table")) + mvcount(split(url, "create%20database")) + mvcount(split(url, "create%20index")) + mvcount(split(url, "create%20view")) + mvcount(split(url, "delete")) + mvcount(split(url, "drop%20database")) + mvcount(split(url, "drop%20index")) + mvcount(split(url, "drop%20table")) + mvcount(split(url, "exists")) + mvcount(split(url, "exec")) + mvcount(split(url, "group%20by")) + mvcount(split(url, "having")) + mvcount(split(url, "insert%20into")) + mvcount(split(url, "inner%20join")) + mvcount(split(url, "left%20join")) + mvcount(split(url, "right%20join")) + mvcount(split(url, "full%20join")) + mvcount(split(url, "select")) + mvcount(split(url, "distinct")) + mvcount(split(url, "select%20top")) + mvcount(split(url, "union")) + mvcount(split(url, "xp_cmdshell")) - 24 \
| where num_sql_cmds > 1\
| eval whiteleafuc="WLUC6"\
| eval prompt = url\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL010 - Suspicious Powershell Commands - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1059"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL010 - Suspicious Powershell Commands
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 10 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=powershell.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  \
| rename Processes.* AS *\
| search (process=*-EncodedCommand* OR process=*-enc*) process=*-Exec* \
| eval whiteleafuc="WLUC10"\
| eval prompt=process\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user

[Threat - WL011 - Suspicious Linux Commands - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1059"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL011 - Suspicious Linux Commands
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 11 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count values(Processes.process) values(Processes.process_name) values(Processes.parent_process_name) dc(Processes.process) as distinct_commands dc(Processes.process_name) as distinct_process_names min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where [\
|inputlookup linux_tool_discovery_process \
| rename process as Processes.process \
|table Processes.process] by _time span=5m Processes.user Processes.dest \
| rename Processes.* AS *\
| where distinct_commands > 20 AND distinct_process_names > 1\
| eval whiteleafuc="WLUC11"\
| eval prompt=process\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user

[Threat - WL012 - Monti Chrome Ransomware Attack - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1072"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL012 - Monti Chrome Ransomware Attack
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 12 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats  values(Processes.process) AS processes values(Processes.action) AS action min(_time) AS attack_start_time values(Processes.os) AS os values(Processes.hash) AS hashes from datamodel=Endpoint.Processes by Processes.dest Processes.user \
| rename Processes.* AS * \
| search processes="*chrome*"\
| eval prompt="Processes". processes ." Hashes ". hashes\
| eval whiteleafuc="WLUC12"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user

[Threat - WL015 - Windows Credential Dumping - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1003"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL015 - Windows Credential Dumping
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 15 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=windows ```needs to look for sysmon data``` EventCode=10 TargetImage=*\\lsass.exe granted_access IN ("0x01000", "0x1010", "0x1038", "0x40", "0x1400", "0x1fffff", "0x1410", "0x143a", "0x1438", "0x1000") CallTrace IN ("*dbgcore.dll*", "*dbghelp.dll*", "*ntdll.dll*", "*kernelbase.dll*", "*kernel32.dll*") NOT SourceUser IN ("NT AUTHORITY\\SYSTEM", "NT AUTHORITY\\NETWORK SERVICE") \
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace SecurityID TargetImage dest granted_access parent_process_id parent_process_name parent_process_path process_id process_name process_path signature user_id  \
| eval prompt=CallTrace.",". granted_access.",". TargetImage\
| eval whiteleafuc="WLUC15"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user_id param.risk_object_type=user

[Threat - WL016 - Linux Deletion of Services or Jobs - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1070"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL016 - Linux Deletion of Services or Jobs
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 16 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where (Filesystem.action=deleted Filesystem.file_path IN ( "/etc/systemd/*", "*/lib/systemd/*", "*/run/systemd/*") Filesystem.file_path = "*.service") OR (Filesystem.action=deleted Filesystem.file_path="/etc/cron.*") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_size Filesystem.process_id Filesystem.user\
| rename Filesystem.* AS *\
| eval prompt = file_path\
| eval whiteleafuc="WLUC16"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL017 - Linux Deletion of Critical Files - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1070"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL017 - Linux Deletion of Critical Files
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 17 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name =rm AND Processes.process= "* -rf *" AND Processes.process IN ("*/boot/*", "*/var/log/*", "*/etc/*", "*/dev/*") by Processes.action Processes.dest Processes.parent_process Processes.parent_process_exec Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_name Processes.process_path Processes.user\
| rename Processes.* AS *\
| eval prompt = process\
| eval whiteleafuc="WLUC17"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL018 - Linux Deletion of Infra Support - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1070"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL018 - Linux Deletion of Infra Support
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 18 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where (Filesystem.action=deleted Filesystem.file_path = "/etc/ssl/certs/*" Filesystem.file_path IN ("*.pem", "*.crt")) OR (Filesystem.action=deleted Filesystem.file_path IN ( "/etc/init.d/*")) by Filesystem.action Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.file_path Filesystem.file_size Filesystem.user \
| rename Filesystem.* AS *\
| eval prompt = file_path\
| eval whiteleafuc="WLUC18"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL020 - O365 PST Exports - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1114"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL020 - O365 PST Exports
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 1
alert.suppress.fields = user
alert.suppress.period = 10800s
alert.track = 1
counttype = number of events
cron_schedule = 20 * * * *
disabled = 1
dispatch.earliest_time = -4h
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=o365 ```add o365 macro``` sourcetype=o365:management:activity Category=ThreatManagement Name="eDiscovery search started or exported" NOT Severity=Informational \
| stats count earliest(_time) as firstTime latest(_time) as lastTime by Source Severity AlertEntityId Operation Name user\
| eval prompt=count\
| eval whiteleafuc="WLUC20"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user

[Threat - WL021 - Windows WMI Suspicious Execution - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1047"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL021 - Windows WMI Suspicious Execution
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 21 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=wmic.exe OR Processes.original_file_name=wmic.exe) Processes.process = "* process *" Processes.process = "* call *" Processes.process = "* create *" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_name Processes.process_path Processes.user\
| rename Processes.* AS *\
| eval prompt=process\
| eval whiteleafuc="WLUC21"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL022 - Windows Suspicious CertUtil Activity - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1105"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL022 - Windows Suspicious CertUtil Activity
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 22 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where ((Processes.process_name=certutil.exe OR Processes.original_file_name=CertUtil.exe) (Processes.process="*urlcache*" OR Processes.process="*verifyctl*") (Processes.process="*/f *" OR Processes.process="*-f *")) OR (Processes.process_name=certutil.exe AND (Processes.process = "*-exportPFX*" OR Processes.process=*decode*)) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_name Processes.process_path Processes.user \
| rename Processes.* AS *\
| eval prompt=process\
| eval whiteleafuc="WLUC22"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL024 - Windows Suspicious MSBuild Activity - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1127"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL024 - Windows Suspicious MSBuild Activity
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 24 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count values(Processes.process_name) as process_name values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where ((Processes.parent_process_name IN ("wscript.exe", "cscript.exe") OR Processes.process_path!=*\\framework*\\v*\\* OR Processes.parent_process_name=wmiprvse.exe) AND (Processes.process_name=msbuild.exe OR Processes.original_file_name=MSBuild.exe)) OR (Processes.process_name!=msbuild.exe AND Processes.original_file_name=MSBuild.exe) by Processes.action Processes.dest Processes.parent_process Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_name Processes.process_path Processes.user \
|  rename Processes.* AS *\
| eval prompt=process\
| eval whiteleafuc="WLUC24"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL025 - Windows Credential Access from Browser Password Store - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1012"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL025 - Windows Credential Access from Browser Password Store
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 25 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = ```wineventlog_security``` EventCode=4663 \
| stats count by _time object_file_path object_file_name dest process_name process_path process_id EventCode \
| lookup browser_app_list browser_object_path as object_file_path OUTPUT browser_process_name isAllowed \
| stats count min(_time) as firstTime max(_time) as lastTime values(object_file_name) values(browser_process_name) as browser_process_name values(isAllowed) AS isAllowed by dest process_name process_path process_id EventCode object_file_path\
| rex field=process_name "(?<extracted_process_name>[^\\\\]+)$" \
| eval isMalicious=if(match(browser_process_name, extracted_process_name), "0", "1") \
| where (isMalicious=1 and isAllowed="false") OR (object_file_path="*\\AppData\\Local\\Google\\Chrome\\User Data\\Local State" NOT (process_name IN ("*\\chrome.exe","*:\\Windows\\explorer.exe"))) OR (object_file_path="*\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data" AND NOT (process_path IN ("*:\\Windows\\explorer.exe", "*:\\Windows\\System32\\dllhost.exe", "*\\chrome.exe"))) \
| eval prompt=process_path\
| eval whiteleafuc="WLUC25"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL026 - Windows Suspicious Process Injection - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1055"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL026 - Windows Suspicious Process Injection
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 26 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = ```sysmon``` (EventCode=10 TargetImage IN ("*\\notepad.exe", "*\\wordpad.exe", "*\\calc.exe", "*\\mspaint.exe", "*\\lsass.exe", "*\\svchost.exe", "*\\backgroundtaskhost.exe", "*\\dllhost.exe", "*\\regsvr32.exe", "*\\searchprotocolhost.exe", "*\\werfault.exe", "*\\wuauclt.exe", "*\\spoolsv.exe", "*\\chrome.exe", "*\\edge.exe", "*\\firefox.exe") NOT (SourceImage IN ("*\\system32\\*","*\\syswow64\\*","*\\Program Files\\*", "*\\Program Files (x86)\\*")) GrantedAccess IN ("0x40","0x1fffff", "0x1f3fff")) OR (EventCode=8 TargetImage = "*.exe" AND NOT (SourceImage IN("C:\\Windows\\*", "C:\\Program File*", "%systemroot%\\*")))\
| stats values(user) as user, min(_time) as firstTime, max(_time) as lastTime, count by dest user_id parent_process_name process_name process_id signature SourceImage TargetImage CallTrace \
| eval CallTrace=split(CallTrace, "|") \
| eval prompt=TargetImage\
| eval whiteleafuc="WLUC26"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user_id\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL027 - Windows Suspicious Schedule Task Created - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1053"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL027 - Windows Suspicious Schedule Task Created
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 27 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = ```wineventlog_security``` EventCode=4698 TaskContent IN ("*\\users\\public\\*", "*\\programdata\\*", "*\\temp\\*", "*\\Windows\\Tasks\\*", "*\\appdata\\*", "*\\perflogs\\*", "*powershell.exe*", "*wscript.exe*", "*cscript.exe*", "*cmd.exe*", "*sh.exe*", "*ksh.exe*", "*zsh.exe*", "*bash.exe*", "*scrcons.exe*", "*pwsh.exe*") \
| stats count min(_time) as firstTime max(_time) as lastTime by Computer, TaskName, TaskContent \
| rename Computer as dest \
| eval prompt=TaskContent\
| eval whiteleafuc="WLUC27"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL028 - Suspicious Ransomware Extension - Rule]
action.correlationsearch.annotations = {"kill_chain_phases":[],"mitre_attack":["T1485"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL028 - Suspicious Ransomware Extension
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 28 * * * *
description = Identifies endpoints where users or processes create files with extensions commonly used by ransomware
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats min(_time) as firstTime max(_time) as lastTime count latest(Filesystem.user) as user values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_size Filesystem.user \
| rename Filesystem.* AS *\
| rex field=file_name "(?<file_extension>\.[^\.]+)$" \
| lookup update=true ransomware_extensions_lookup Extensions AS file_extension OUTPUT Extensions Name \
| search Name !=False \
| eval prompt=file_name\
| eval whiteleafuc="WLUC28"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user

[Threat - WL031 - Suspicious Email Attachment Extensions - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1566.001"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL031 - Suspicious Email Attachment Extensions
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 31 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Email where All_Email.file_name="*" by All_Email.file_name, All_Email.src_user, All_Email.message_id \
| rename All_Email.* AS *\
| eval prompt=file_name\
| eval whiteleafuc = "WLUC31"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=src_user param.risk_object_type=user

[Threat - WL032 - Suspicious BITS Activity - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1197","T1105"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL032 - BITSAdmin Download File/BITS Job Persistence
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 32 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process (Processes.process_name=bitsadmin.exe OR Processes.original_file_name=bitsadmin.exe) IN ("*transfer*", "*addfile*", *create*, *addfile*, *setnotifyflags*, *setnotifycmdline*, *setminretrydelay*, *setcustomheaders*, *resume* ) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_path Processes.process Processes.process_hash Processes.process_id Processes.process_name Processes.process_path Processes.user\
| rename Processes.* AS *\
| eval prompt = process\
| eval whiteleafuc = "WLUC32"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL034 - Credential Dumping Detection - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1003.003"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL034 - Credential Dumping Detection
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 34 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=cmd.exe OR Processes.original_file_name=Cmd.Exe) (Processes.process=*\\system32\\config\\sam* OR Processes.process=*\\system32\\config\\security* OR Processes.process=*\\system32\\config\\system* OR Processes.process=*\\windows\\ntds\\ntds.dit* OR Processes.process=*mklink* OR  Processes.process=*HarddiskVolumeShadowCopy*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_path Processes.process Processes.process_name Processes.process_path Processes.user \
\
| rename Processes.* AS *\
| eval prompt = process\
| eval whiteleafuc = "WLUC34"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL033 - AzureHound File and Command Line Detection - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1069.001","T1069.002","T1087.001","T1087.002","T1482"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL033 - AzureHound File and Command Line Detection
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 33 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime \
  from datamodel=Endpoint.Processes \
  where Processes.process IN ("*invoke-azurehound*") \
  by Processes.action Processes.dest Processes.original_file_name Processes.parent_process \
     Processes.parent_process_name \
     Processes.parent_process_path Processes.process \
     Processes.process_id Processes.process_name \
     Processes.process_path Processes.user \
| rename Processes.* AS * \
| append [\
| tstats count min(_time) as firstTime max(_time) as lastTime \
  from datamodel=Endpoint.Filesystem \
  where Filesystem.file_name IN ("*-azurecollection.zip", "*-azprivroleadminrights.json", "*-azglobaladminrights.json", "*-azcloudappadmins.json", "*-azapplicationadmins.json") \
  by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time \
     Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path \
     Filesystem.file_acl Filesystem.file_size \
     Filesystem.user \
| rename Filesystem.* AS * ]\
| eval prompt = case(isnotnull(process), process, isnotnull(file_name), file_name, 1=1, "whiteleaf ignore")\
| eval whiteleafuc = "WLUC33"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL007 - Process Executed from Suspicious File Path - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1543"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL007 - Process Executed from Suspicious File Path
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 7 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count from datamodel=Endpoint.Processes where Processes.process_path=*  by Processes.process_path Processes.dest Processes.user \
| `drop_dm_object_name(Processes)`\
| lookup common_paths_for_processes.csv process_path OUTPUT is_known\
| where NOT is_known = 1\
| eval whiteleafuc="WLUC7"\
| eval prompt = process_path\
| whiteleafai \
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user

[Threat - WL008 - Lookalike Domains in Email - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1583"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL008 - Lookalike Domains in Email
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 8 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count from datamodel=Email.All_Email where All_Email.src_user_domain=* All_Email.recipient_domain=* by All_Email.recipient All_Email.src_user All_Email.subject \
| `drop_dm_object_name(All_Email)` \
| lookup top_1000_email_domains.csv domain AS src_user_domain OUTPUT is_known AS src_domain_known \
| lookup top_1000_email_domains.csv domain AS recipient_domain OUTPUT is_known AS recipient_domain_known \
| where recipient_domain_known = 0 AND src_domain_known = 0 \
| eval whiteleafuc="WLUC8"\
| eval prompt = src_user_domain.",".recipient_domain\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=recipient param.risk_object_type=user

[Threat - WL009 - Lookalike Domains in Web - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1583"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL009 - Lookalike Domains in Web
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 9 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count from datamodel=Web where Web.url_domain=* by Web.user Web.dest Web.action \
| `drop_dm_object_name(Web)` \
| lookup top_1000_domains.csv domain AS url_domain OUTPUT is_known AS url_domain_known \
| where url_domain_known = 0\
| eval whiteleafuc="WLUC9"\
| eval prompt = url_domain\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user

[Threat - WL013 - LOLBAS Network Traffic - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1105","T1567","T1218"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL013 - LOLBAS Network Traffic
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 13 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic.All_Traffic where All_Traffic.app=* by All_Traffic.app,All_Traffic.src,All_Traffic.src_ip,All_Traffic.user,All_Traffic.dest,All_Traffic.dest_ip \
| rename All_Traffic.* AS *\
| lookup top_1000_network_traffic_apps.csv app OUTPUT is_known\
| where NOT is_known=1\
| eval prompt=app\
| eval whiteleafuc="WLUC13"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user

[Threat - WL030 - Rare Executables Detection - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1204"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL030 - Rare Executables Detection
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 30 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats dc(Processes.dest) as dc_dest values(Processes.dest) as dest values(Processes.user) as user min(_time) as firstTime max(_time) as lastTime values(Processes.action) as action values(Processes.original_file_name) as original_file_name values(Processes.parent_process) as parent_process values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_path) as process_path values(Processes.user) as user from datamodel=Endpoint.Processes by Processes.process_name \
| rename Processes.* AS *\
| lookup common_process_names.csv process_name OUTPUT is_common\
| where NOT is_common=1\
| eval prompt=process_name . ">" . "dc_dest"\
| eval whiteleafuc = "WLUC30"\
| whiteleafai\
| mvexpand dest\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system


[Threat - WL035 - AWS Login Elements Creation - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1078.004","T1136.003","T1201"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL035 - AWS Login Elements Creation
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 35 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = sourcetype=aws:cloudtrail (eventSource="iam.amazonaws.com" AND eventName IN ("CreatePolicyVersion", "SetDefaultPolicyVersion","CreateAccessKey", "UpdateAccountPasswordPolicy", "GetAccountPasswordPolicy", "DeleteAccountPasswordPolicy","CreateLoginProfile")) OR (eventName="ConsoleLogin")\
| eval user=coalesce(user_name, userIdentity.userName)\
| eval is_console_login=if(eventName="ConsoleLogin", 1, 0)\
| eval is_dangerous_policy=if(eventName="CreatePolicyVersion" AND like(requestParameters.policyDocument, "%Action\":\"*%"), 1, 0)\
| eval is_key_mismatch=if(eventName="CreateAccessKey" AND userIdentity.userName != requestParameters.userName, 1, 0)\
| eval is_login_profile_created=if(eventName="CreateLoginProfile", 1, 0)\
| eval is_password_policy_action=if(eventName IN ("UpdateAccountPasswordPolicy", "GetAccountPasswordPolicy", "DeleteAccountPasswordPolicy"), 1, 0)\
| eval is_set_default_policy=if(eventName="SetDefaultPolicyVersion", 1, 0)\
| eval prompt=case(\
    is_dangerous_policy=1, "IAM Policy Created With Action *",\
    is_key_mismatch=1, "CreateAccessKey for Different User",\
    is_console_login=1 AND is_login_profile_created=1, "New Login Profile Logged Into Console",\
    is_password_policy_action=1, "Password Policy Access or Change",\
    is_set_default_policy=1, "Set Default Policy Version")\
| where is_dangerous_policy=1 OR is_key_mismatch=1 OR (is_console_login=1 AND is_login_profile_created=1) OR is_password_policy_action=1 OR is_set_default_policy=1\
| eval whiteleafuc = "WLUC35"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user


[Threat - WL036 - AWS ASL Credential Manipulation - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1110.001","T1586.003","T1110"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL036 - AWS ASL Credential Manipulation
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 36 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = (sourcetype=aws:asl OR sourcetype=aws:cloudtrail)\
(eventName="GetPasswordData" OR api.operation="GetPasswordData" OR eventName="ModifyDBInstance" OR api.operation="ModifyDBInstance" OR api.operation="ModifyDBCluster")\
OR (eventSource="rds.amazonaws.com" AND like(requestParameters.masterUserPassword, "*"))\
OR (sourcetype=aws:asl AND like(api.request.data, "%masterUserPassword%"))\
| eval user=coalesce(user_name, userIdentity.userName, actor.user.uid)\
| eval dest=coalesce(eventSource, api.service.name)\
| eval action=coalesce(eventName, api.operation)\
| eval user_agent=coalesce(user_agent, http_request.user_agent)\
| eval src=coalesce(src, src_endpoint.ip)\
| eval is_password_fetch=if(action="GetPasswordData", 1, 0)\
| eval is_db_password_change=if((action="ModifyDBInstance" OR action="ModifyDBCluster") AND (like(requestParameters.masterUserPassword, "*") OR like(api.request.data, "%masterUserPassword%")), 1, 0)\
| where is_password_fetch=1 OR is_db_password_change=1\
| eval prompt=case(\
    is_password_fetch=1 AND sourcetype="aws:asl", "Retrieved EC2 instance password via ASL",\
    is_password_fetch=1 AND sourcetype="aws:cloudtrail", "Retrieved EC2 instance password via CloudTrail",\
    is_db_password_change=1 AND sourcetype="aws:asl", "Modified DB password via ASL",\
    is_db_password_change=1 AND sourcetype="aws:cloudtrail", "Modified DB password via CloudTrail")\
| eval whiteleafuc = "WLUC36"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL037 - AWS ASL Log Deletion - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1562.008"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL037 - AWS ASL Log Deletion
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 37 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = (sourcetype=aws:asl OR sourcetype=aws:cloudtrail)\
((action=DeleteTrail OR eventName="DeleteTrail") OR (action=DeleteLogGroup OR eventName="DeleteLogGroup") OR\
eventName IN ("DeleteLogStream", "DeleteDetector", "DeleteIPSet", "DeleteWebACL", "DeleteRule", "DeleteRuleGroup", "DeleteLoggingConfiguration", "DeleteAlarms")) AND userAgent != "console.amazonaws.com" AND errorCode = "success"\
| eval user=coalesce(user_name, userIdentity.userName, actor.user.uid)\
| eval dest=coalesce(eventSource, api.service.name)\
| eval action=coalesce(eventName, api.operation)\
| eval user_agent=coalesce(user_agent, http_request.user_agent)\
| eval src=coalesce(src, src_endpoint.ip)\
| eval is_delete_trail=if(action="DeleteTrail", 1, 0)\
| eval is_delete_log_group=if(action="DeleteLogGroup", 1, 0)\
| eval is_detection_evade=if(action IN ("DeleteLogStream","DeleteDetector","DeleteIPSet","DeleteWebACL","DeleteRule","DeleteRuleGroup","DeleteLoggingConfiguration","DeleteAlarms"), 1, 0)\
| where is_delete_trail=1 OR is_delete_log_group=1 OR is_detection_evade=1\
| eval prompt=case(\
    is_delete_trail=1, "CloudTrail trail deleted – attempt to disable audit logging",\
    is_delete_log_group=1, "CloudWatch log group deleted – potential log destruction",\
    is_detection_evade=1, "Security or detection config deleted – potential evasion attempt")\
| eval whiteleafuc = "WLUC37"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user\
| sendalert risk param.risk_score=risk_score param.risk_object_field=dest param.risk_object_type=system

[Threat - WL029 - Password Spray (Many to One) - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1110.003"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL029 - Password Spray (Many to One)
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 29 * * * *
disabled = 1
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats max(_time) as lastTime, min(_time) as firstTime, values(Authentication.user_category) as user_category values(Authentication.src_category) as src_category values(Authentication.app) as app count from datamodel=Authentication.Authentication by Authentication.action Authentication.app Authentication.dest Authentication.src Authentication.user \
| rename Authentication.* AS *\
| eval user=case((match(upper(user),"[a-zA-Z0-9]{3}")),upper(user),true(),null), src=upper(src), success=if(action="success",count,0),success_user=if(action="success",user,null),failure=if(action="failure",count,0), failed_user=if(action="failure",user,null) \
| stats count min(firstTime) as firstTime max(lastTime) as lastTime values(app) as app values(success_user) as user values(failed_user) as failed_user dc(success_user) as success_dc dc(failed_user) as failed_dc dc(user) as user_dc ,sum(failure) as failure,sum(success) as success by src\
| eval success_ratio=success/failure\
| where user_dc >= 5 AND success_ratio < .25 AND failed_dc > success_dc \
| eval prompt=user_dc .">" . success_ratio\
| eval whiteleafuc = "WLUC29"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=src param.risk_object_type=system

[Threat - WL038 - Password Spray (One to Many) - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1110.003"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = WL038 - Password Spray (One to Many)
action.customsearchbuilder.enabled = false
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 38 * * * *
dispatch.earliest_time = -70m
dispatch.latest_time = -10m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats  max(_time) as lastTime, min(_time) as firstTime, values(Authentication.user_category) as user_category values(Authentication.src_category) as src_category values(Authentication.app) as app count from datamodel=Authentication.Authentication by Authentication.action Authentication.app Authentication.dest Authentication.src Authentication.user \
| rename Authentication.* AS *\
| eval user=case((match(upper(user),"[a-zA-Z0-9]{3}")),upper(user),true(),null), success=if(action="success",count,0), src=upper(src), success_src=if(action="success",src,null), failure=if(action="failure",count,0), failed_src=if(action="failure",src,null) \
| stats count min(firstTime) as firstTime max(lastTime) as lastTime values(app) as app values(success_src) as src values(failed_src) as failed_src dc(success_src) as success_dc dc(failed_src) as failed_dc dc(src) as src_dc, sum(failure) as failure, sum(success) as success by user \
| eval success_ratio=success/failure\
| where src_dc >= 5 AND success_ratio < .25 AND failed_dc > success_dc \
| eval prompt=src_dc .">". success_ratio\
| eval whiteleafuc="WLUC38"\
| whiteleafai\
| sendalert risk param.risk_score=risk_score param.risk_object_field=user param.risk_object_type=user
